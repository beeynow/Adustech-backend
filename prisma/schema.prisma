generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ACADEMIC STRUCTURE MODELS
// ============================================================================

model Faculty {
  id          String   @id @default(cuid())
  name        String   @unique
  code        String   @unique
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  
  departments Department[]
  users       User[]     @relation("UserFaculty")
  posts       Post[]
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([isActive])
  @@index([code])
  @@map("faculties")
}

model Department {
  id          String   @id @default(cuid())
  facultyId   String   @map("faculty_id")
  name        String
  code        String
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  
  faculty          Faculty    @relation(fields: [facultyId], references: [id], onDelete: Cascade)
  levels           Level[]
  users            User[]     @relation("UserDepartment")
  managedByAdmins  User[]     @relation("ManagedDepartment")
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([facultyId, code])
  @@index([facultyId])
  @@index([isActive])
  @@map("departments")
}

model Level {
  id           String   @id @default(cuid())
  departmentId String   @map("department_id")
  levelNumber  Int      @map("level_number")
  displayName  String   @map("display_name")
  isActive     Boolean  @default(true) @map("is_active")
  
  department  Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  users       User[]     @relation("UserLevel")
  posts       Post[]
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([departmentId, levelNumber])
  @@index([departmentId])
  @@index([levelNumber])
  @@index([isActive])
  @@map("levels")
}

model Channel {
  id            String          @id @default(cuid())
  createdAt     DateTime        @default(now())
  updatedAt     DateTime
  name          String
  description   String          @default("")
  visibility    String          @default("public")
  createdById   String
  User          User            @relation(fields: [createdById], references: [id], onDelete: Cascade)
  ChannelMember ChannelMember[]

  @@index([createdById])
  @@index([name])
}

model ChannelMember {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  channelId String
  userId    String
  Channel   Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([channelId, userId])
  @@index([channelId])
  @@index([userId])
}

model Comment {
  id            String        @id @default(cuid())
  createdAt     DateTime      @default(now())
  updatedAt     DateTime
  postId        String
  userId        String
  userName      String
  text          String
  parentId      String?
  Comment       Comment?      @relation("CommentToComment", fields: [parentId], references: [id], onDelete: Cascade)
  other_Comment Comment[]     @relation("CommentToComment")
  Post          Post          @relation(fields: [postId], references: [id], onDelete: Cascade)
  User          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  CommentLike   CommentLike[]

  @@index([parentId])
  @@index([postId])
  @@index([userId])
}

model CommentLike {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  commentId String
  userId    String
  Comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId])
  @@index([commentId])
  @@index([userId])
}

model Department {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  name        String   @unique
  code        String   @unique
  description String   @default("")
  faculty     String   @default("")
  levels      String[] @default(["100", "200", "300", "400", "500"])
  isActive    Boolean  @default(true)
  createdById String
  User        User     @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([createdById])
  @@index([isActive])
  @@index([name])
}

model Event {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime
  title         String
  details       String   @default("")
  location      String   @default("")
  startsAt      DateTime
  imageUrl      String   @default("")
  imageBase64   String   @default("")
  pdfUrl        String   @default("")
  createdByName String   @default("")
  expiresAt     DateTime
  createdById   String
  User          User     @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([createdById])
  @@index([expiresAt])
  @@index([startsAt])
}

model Post {
  id           String       @id @default(cuid())
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  userId       String
  userName     String
  category     String       @default("All")
  text         String       @default("")
  imageBase64  String       @default("") @db.Text
  imageUrl     String       @default("")
  department   String       @default("")
  departmentId String       @default("")
  level        String       @default("")
  Comment      Comment[]
  User         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  PostLike     PostLike[]
  PostRepost   PostRepost[]

  @@index([category])
  @@index([createdAt])
  @@index([departmentId])
  @@index([department])
  @@index([level])
  @@index([userId])
}

model PostLike {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  postId    String
  userId    String
  Post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

model PostRepost {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  postId    String
  userId    String
  Post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

model Session {
  sid    String   @id
  sess   Json
  expire DateTime

  @@index([expire])
}

model Timetable {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime
  title         String
  details       String   @default("")
  effectiveDate DateTime
  imageUrl      String   @default("")
  pdfUrl        String   @default("")
  createdByName String   @default("")
  expiresAt     DateTime
  createdById   String
  User          User     @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([createdById])
  @@index([effectiveDate])
  @@index([expiresAt])
}

model User {
  id                   String          @id @default(cuid())
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  name                 String
  email                String          @unique
  password             String
  otp                  String?
  otpExpiry            DateTime?
  isVerified           Boolean         @default(false)
  bio                  String          @default("")
  profileImage         String          @default("")
  level                String          @default("")
  department           String          @default("")
  faculty              String          @default("")
  phone                String          @default("")
  dateOfBirth          DateTime?
  gender               String          @default("")
  address              String          @default("")
  country              String          @default("")
  resetPasswordToken   String?
  resetPasswordExpires DateTime?
  role                 String          @default("user")
  Channel              Channel[]
  ChannelMember        ChannelMember[]
  Comment              Comment[]
  CommentLike          CommentLike[]
  Department           Department[]
  Event                Event[]
  Post                 Post[]
  PostLike             PostLike[]
  PostRepost           PostRepost[]
  Timetable            Timetable[]

  @@index([department])
  @@index([email])
  @@index([level])
  @@index([role])
}
